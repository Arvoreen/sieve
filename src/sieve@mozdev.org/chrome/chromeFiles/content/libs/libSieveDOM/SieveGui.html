<!DOCTYPE html>
<html>
<head>
  <title>Sieve DOM</title>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
  <link rel="stylesheet" href="style.css" type="text/css" />
</head>
<body>

  <script src="SieveLexer.js" type="text/javascript"></script>
 
  <script src="logic/Elements.js" type="text/javascript"></script>  
  <script src="logic/RFC3028/SieveBlocks.js" type="text/javascript"></script>
  
  <script src="SieveScriptDOM.js" type="text/javascript"></script>

  
  <script type="application/javascript" src="UI/jquery.js"></script>
  <script type="application/javascript" src="UI/jquery-ui.js"></script>
  
  <script type="application/javascript" src="UI/events/DropHandler.js"></script> 
  
  <script type="application/javascript" src="UI/Boxes.js"></script>
  <script type="application/javascript" src="UI/Actions.js"></script>
  <script type="application/javascript" src="UI/Blocks.js"></script>  
  <script type="application/javascript" src="UI/Conditions.js"></script>  
  <script type="application/javascript" src="UI/widgets/Tests.js"></script>  
  <script type="application/javascript" src="UI/widgets/Strings.js"></script>  
  
  

  <script src="logic/RFC3028/SieveOperators.js" type="text/javascript"></script>

  <script src="logic/RFC3028/SieveImports.js" type="text/javascript"></script>
  <script src="logic/RFC3028/SieveActions.js" type="text/javascript"></script>
  <script src="SieveAtoms.js" type="text/javascript"></script>

  <script src="logic/RFC3028/SieveWhiteSpaces.js" type="text/javascript"></script>
  <script src="logic/RFC3028/SieveStrings.js" type="text/javascript"></script>
  <script src="logic/ImapFlags/SieveImapFlags.js" type="text/javascript"></script>
  <script src="logic/RFC3028/SieveConditions.js" type="text/javascript"></script>
  <script type="text/javascript" src="logic/RFC3028/SieveTests.js"></script>

<script type="text/javascript">
//<![CDATA[
$(document).ready(function() {
  init();
  
  // editable and draggabel areas do not like eachother too much...
  // ... so ensure that we are either editable or draggable but never both
  $("#divOutput").mouseover(function(ev) {
  
     switch (ev.target.nodeName)
	 {
	   case "INPUT":
       case	 "TEXTAREA" :
	     $("[draggable=true]").attr("draggable","false");
		 break;
		 
		default:
		  $("[draggable=false]").attr("draggable","true"); 
	 }	   
	   
    $("#draggable").val(ev.target.nodeName)});
});

function setSieveScript(script)
{
    // reset environemnt
	init();
	
	if (!script)
	  script =$('#txtScript').val();
	 else
	  $('#txtScript').val(script);
	
    dom2.script(script);
	
	$("#txtOutput")
	  .val(dom2.script());
	  
	$("#divOutput")
	  .empty()
	  .append(dom2.widget())	
}

function getSieveScript()
{
  return dom2.script();
}

function require()
{
  var requires = {};
  
  dom2.root().require(requires);
  
  for (var i in requires)
    alert(i);  
}

function compact()
{
  alert(dom2.compact());
}
function debug(obj)
{
  //var logger = Components.classes["@mozilla.org/consoleservice;1"].getService(Components.interfaces.nsIConsoleService);

  var str = "";
  for (tempVar in obj)
    str += tempVar+"\n";
	
  alert(str);
  //logger.logStringMessage(str);
}

  function createMenuItem(action,flavour, docShell)
  {    
    var elm2 = (new SieveDragBoxUI(docShell));
    elm2._elmType = action;
    elm2._action = "create";
    elm2._flavour = flavour;
	
    return elm2.getWidget()
                    .append($(document.createTextNode(action.split('/')[1])))	
  }

  function init()
  {
    // Yes it's a global object
    dom2 = new SieveDocument(SieveLexer);
	
	var docShell = dom2;
	
    var elm = $("#sivActions").empty();
    
	elm.append($("<div/>").text("Actions"))
	  .text("Actions");
	  
    for (var key in SieveLexer.types["action"])
      elm.append(createMenuItem(key,"sieve/action",docShell));

	elm.append($("<div/>").text("Tests"))
    
    for (var key in SieveLexer.types["test"])
      elm.append(createMenuItem(key,"sieve/test",docShell).get(0));

	elm
	  .append($(document.createElement('div'))
	    .addClass("spacer"))
      .append($(new SieveTrashBoxUI(docShell).getWidget())
	    .attr('id','trash'));
  }
//]]>
</script>

<div style="margin-left:200px;">
<div>
   <div id="boxScript" style="display:none;overflow: hidden;width: 100%; ">  
     <div style="float:left; padding:5px;">
        <div>Input:</div>
        <textarea id="txtScript" cols="50" rows="10" wrap="off">
redirect "test";
        </textarea>
      </div>
      <div style="float:left; padding:5px;">
        <div>Result:</div>
        <textarea id="txtOutput" cols="50" rows="10" readonly="readonly" wrap="off"></textarea>
      </div>
    </div>
</div >
<div>
    <button onclick="setSieveScript();">
	   Parse Sieve Script
	 </button>
    <button onclick="$('#txtOutput').val(getSieveScript());">
	  Update Sieve Script
	</button>
    <button onclick="require()">
	  Collect Require
	</button>	
    <button onclick="compact()">
	  Compact
	</button>		
    <button onclick="$('#boxScript').toggle()">
	  Show/Hide
	</button>		
	<input id="draggable" />
</div>
</div>

<div>   
  <div>
    <!--<div id="sivActions" style="background-color:gray;overflow-y: scroll;width:150px;float: left;">  -->
	<div id="sivActions" class="floating-menu">
	 </div>
  </div>
  
  <div id="divOutput">
  </div>
</div>  
</body>
</html>